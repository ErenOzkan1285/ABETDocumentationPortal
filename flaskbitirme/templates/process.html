<!DOCTYPE html>
{% extends "layout.html" %}

{% block title %}Process{% endblock %}

{% block content %}

    <div class="container">
        <div class="score-container">
            <h2>Excel Preview</h2>
            <!-- Table to display processed data -->
            <table class="table table-bordered" id="survey">
                <thead>
                <tr>
                    <th scope="col" class="col-4">Specific Outcomes of Instructions</th>
                    <th scope="col" class="col-2">PI's</th>
                    <th scope="col" class="col-2">Target Score</th>
                    <th scope="col" class="col-2">Actual Score</th>
                    <th scope="col" class="col-2">Student Score</th>
                    <th scope="col" class="col-2">Status</th>
                </tr>
                </thead>
                <tbody id="processed-table-body"></tbody>
            </table>

            <div class="d-flex justify-content-between">
                <button type="submit" id="go-back" class="btn btn-back btn-lg">Go Back</button>
                <button type="submit" id="download" class="btn btn-result btn-lg">Download</button>
            </div>

        </div>
    </div>

    <script type="text/javascript">
        function fetchSurvey() {
            fetch('/api/secondpage')
                .then(response => response.json())
                .then(data => {
                    console.log('Fetched data:', data);
                    data = data[6];
                    var tbody = document.getElementById('processed-table-body');

                    if (typeof data === 'object' && Object.keys(data).length > 0) {

                        var questionNames = Object.keys(data).sort();

                        questionNames.forEach(question => {
                            var tr = document.createElement('tr');

                            var tdQuestion = document.createElement('td');
                            tdQuestion.textContent = '';
                            tdQuestion.classList.add('align-left');

                            var tdPis = document.createElement('td');
                            tdPis.textContent = 'PI-f1';

                            var tdTargetScore = document.createElement('td');
                            tdTargetScore.textContent = '3.00';

                            var tdStudentScore = document.createElement('td');
                            tdStudentScore.textContent = parseFloat(data[question]).toFixed(2);

                            var tdActualScore = document.createElement('td');
                            var tdStatus = document.createElement('td');

                            if (tdPis.textContent === 'PI-f1') {
                                const queryParams = new URLSearchParams(window.location.search);
                                const piWeightResultString = queryParams.get('PI-f1');
                                const piWeightResult = JSON.parse(piWeightResultString);

                                const actualScore = piWeightResult * 5;

                                tdActualScore.textContent = actualScore.toFixed(2);

                                if (actualScore > parseFloat(tdTargetScore.textContent)) {
                                    tdStatus.innerHTML = '<strong style="color: green;">Adequate</strong>';
                                } else {
                                    tdStatus.innerHTML = '<strong style="color: red;">Inadequate</strong>';
                                }
                            }

                            tr.appendChild(tdQuestion);
                            tr.appendChild(tdPis);
                            tr.appendChild(tdTargetScore);
                            tr.appendChild(tdActualScore);
                            tr.appendChild(tdStudentScore);
                            tr.appendChild(tdStatus);

                            tbody.appendChild(tr);
                        });
                    } else {
                        console.error('Invalid data structure or empty data.');
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        document.addEventListener('DOMContentLoaded', function () {
            fetchSurvey();
        });
    </script>

{% endblock %}
